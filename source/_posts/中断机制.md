---
title: 中断机制
date: 2021-03-19 23:55:12
categories: 操作系统
tags: 操作系统
---

> 在计算机就科学中，中断是指处理器接收到来自硬件或软件的信号，提示发生了某个事件，应该被注意，这种情况就称为中断。
>
> 通常，在接收到来自外围设备的异步信号，或来自软件的同步信号之后，处理器将会进行相应的硬件/软件处理。发出这样的信号称为进行中断请求。硬件中断导致处理器通过一个 context switch 来保存执行状态；软件中断则通常作为 CPU 指令集中的一个指令，以可编程的方式直接只是这种运行信息切换，并将处理导向一段中断处理代码

<!-- more -->

中断通常被称为**同步中断**和**异步中断**

- 同步中断，也叫做异常，是指令执行时由 CPU 产生的，只有在一条指令终止执行后 CPU 才会发出中断
- 异步中断，也叫做（外部）中断，是由其他硬件设备依照 CPU 时钟信号随机产生的

### 中断

中断，即异步中断，是其他硬件按照 CPU 时钟信号随机产生的，比如事件中断、I/O 中断。例如用户的一次按键会引起一个中断。之所以称为异步中断，是因为当硬件生成中断时，中断处理器与当前运行的进程在 CPU 上没有任何关联，CPU 和生成中断的设备时并行运行的。

中断提供了一种特殊的方式，使处理器转而去运行正常的控制流之外的代码。当一个中断信号到达时，中断控制器会通知当前有一个待处理的中断，其中一个 CPU 会接收中断，调用相应的中断处理程序处理中断。中单处理完成后，CPU 会通知中断控制器中断完成。

### 异常

异常，即同步中断，是指令执行 CPU 控制单元产生的，之所以称为同步，是因为只有在一条指令终止执行后 CPU 才会发出中断。按引起异常的指令是否能重新执行，且依据他们被报告的方式，异常可以被分为错误、陷阱和终止三种情况

- 错误：错误是一种能够被修正的异常，一旦修正，程序能够接着执行，比如页错误
- 陷阱：当程序执行系统调用时，会 trap 到内核态
- 终止：它并不总是报告产生异常的指令的确定位置，也不允许引起终止的进程或任务重新执行，如总线错误导致异常终止。

#### trap

当程序执行系统调用时会导致用户空间和内核空间的切换，这个切换被称为 trap。在这个过程种，需要进行保存用户寄存器的信息、程序计数器等信息，这些信息表明了执行系统调用时计算机的状态。在 trap 处理的过程中，我们需要更改这些状态，或者对状态做一些操作，这样我们才能运行内核中的程序。一般 trap 的处理过程需要做以下事情：

- 保存用户寄存器，因为我们希望在下次恢复执行的时候能够恢复此时的状态这就意味着用户寄存器不能被内核修改，所以我们需要保存他们
- 保存程序计数器，程序计数器指示着当前执行指令的位置，为了让程序恢复执行时知道从何处接着执行，我们也需要保存程序计数器的值
- 更改用户模式，因为要从用户空间切换到内核空间，所以我们需要修改处理器的标识位，以便使用内核中的特权指令
- 跳入内核

当一个系统调用发生时，用户空间通过向内核空间发出 `syscall` 产生软中断（int80），让程序陷入到内核态，跳到内核中一个固定的位置。陷入内核后，在中断向量表中根据中断识别码查询到相应的中断处理程序，调用相应的系统调用。